# 要件定義書：Play Review Triage（仮称）
最終更新: 2026-02-22  
作成者: のぶこふ / ChatGPT  
対象: Android（Kotlin + Jetpack Compose）

---

## 0. この文書の目的
本アプリの「何を作るか（要件）」を明確にし、実装・テスト・リリースで迷わないための基準を定める。  
※「どう作るか（設計）」は外部設計書・アーキ設計書で扱う。

---

## 1. プロダクト概要（再掲）
### 1.1 コンセプト
Google Playレビューを重要度で仕分けし、開発者に「今日やるべきTop3」を提示する。

### 1.2 MVPで提供する価値（最小）
- Google連携（OAuth）
- Google Playレビュー取得（主に★1〜2）
- 重要度判定（HIGH/MID/LOW）と理由タグ
- Today画面：Top3提示
- 朝1回通知（重要レビューがある場合のみ）
- 401/403等の分かりやすい案内

---

## 2. 対象ユーザー / 利用シーン
### 2.1 対象ユーザー（一次）
- 個人開発者 / 小規模チーム（1〜3人）
- アプリ運用経験は浅くてもよい
- Play Console権限を持つGoogleアカウントを使用

### 2.2 主な利用シーン
- 朝：通知で重要レビューの存在だけ知る → タップしてTop3確認
- 夜：Top3を元に修正タスクを決める
- ★1急増：見に行かず通知で気付く（ただしMVPでは「急増検知」は未実装）

---

## 3. 用語定義（新人向け）
- OAuth：Googleアカウントと連携し、API利用を許可してもらう仕組み
- アクセストークン：API呼び出しに使う短命の鍵（漏らすと危険）
- 401：認証が無効（トークン期限切れ等）
- 403：権限不足（Play Console権限がない、対象アプリにアクセスできない等）
- トリアージ：重要度で仕分けし、優先順位を決めること
- MVP：最小限の価値を届ける最初の完成品

---

## 4. スコープ（MVP範囲）
### 4.1 MVPで「やること」(Must)
- Googleログインによる連携
- 監視対象アプリ（packageName）の設定（1つ）
- レビュー取得（★1〜2を中心に扱う）
- レビューの重要度判定（ルールベース v1）
- Today（Top3）表示
- レビュー詳細表示
- 朝1回通知（重要レビューがある場合のみ）
- 例外表示（401/403/ネットワーク）をユーザーに分かる文章で提示
- ログ/クラッシュ収集の導入（Crashlytics等）

### 4.2 MVPで「やらないこと」(Won't)
- ASO最適化機能
- 競合分析・売上推定
- 返信の完全自動化（AI返信生成はMVP外）
- 複数アプリ同時監視（将来対応）
- 高度なAI分類（精度100%狙い）

---

## 5. 画面要件（機能の入口）
※UI詳細は外部設計書で定義する。ここでは「画面の存在」と「何ができるか」を決める。

### 5.1 画面一覧（MVP）
1) SignIn画面  
- Google連携開始ボタン
- 連携が必要な理由の説明
- エラー表示

2) Setup（初期設定）画面  
- 監視対象の `packageName` を入力・保存（例: com.example.app）
- 入力チェック（空欄/形式の簡易チェック）
- 「このpackageNameにアクセス権がない」場合の案内（403時）

3) Today画面  
- 今日の重要レビューTop3表示
- 重要度（HIGH/MID/LOW）と理由タグ表示
- 同期状態（最終同期時刻）
- 手動更新（リフレッシュ）

4) Review Detail画面  
- レビュー本文（テキスト）
- 重要度/理由
- 作成日時
- 「Play Consoleで開く」（MVPではリンクのみ、返信機能は無し）

5) Settings画面（最小）
- 監視対象packageNameの変更
- 連携解除（ログアウト）
- データ保持方針（保持期間）を表示
- 通知権限（Android 13+）の許可導線（未許可時に許可要求できる）

---

## 6. 機能要件（FR：Functional Requirements）
各要件に優先度を付ける（Must/Should/Could）。

### 6.1 認証・連携（Auth）
**FR-AUTH-001（Must）**  
ユーザーはGoogleアカウントでサインインできる。

**FR-AUTH-002（Must）**  
アプリはAndroid Publisher APIを呼ぶためのアクセストークンを取得し、期限切れを考慮して更新または再ログイン誘導できる。

**FR-AUTH-003（Must）**  
ログアウト（連携解除）時、端末内のトークンおよび関連キャッシュを削除する。

**FR-AUTH-004（Must）**  
アクセストークン等の機微情報をログ出力しない。

---

### 6.2 監視対象アプリ設定（Target App）
**FR-TGT-001（Must）**  
ユーザーは監視対象アプリの `packageName` を1つ設定できる。

**FR-TGT-002（Must）**  
設定した `packageName` に対するAPIアクセスが403等で拒否された場合、  
「権限不足の可能性」「Play Console権限を確認」などの対処案内を表示する。

**FR-TGT-003（Should）**  
`packageName` の入力を簡易検証する（空欄不可、英数字/ドット等の基本フォーマット）。

---

### 6.3 レビュー取得・同期（Fetch/Sync）
**FR-SYNC-001（Must）**  
アプリは対象 `packageName` のレビューを取得し、端末内に保存（キャッシュ）する。

**FR-SYNC-002（Must）**  
レビュー取得に失敗した場合、ユーザーに原因（ネットワーク/401/403/その他）を分かる形で表示する。

**FR-SYNC-003（Must）**  
最終同期時刻を保持し、Today画面で表示する。

**FR-SYNC-004（Should）**  
手動更新（pull-to-refresh等）で再同期できる。

**FR-SYNC-005（Could / 将来）**  
差分同期（前回以降の更新分のみ）を実装し、API負荷を下げる。

---

### 6.4 重要度判定（Triage）
**FR-TRI-001（Must）**  
取得したレビューに対し、重要度（HIGH/MID/LOW）と理由タグを付与する。

**FR-TRI-002（Must）**  
重要度判定はMVPではルールベースで行う（AIは必須としない）。

**FR-TRI-003（Must）**  
判定ルールは将来差し替え可能な構造で実装する（設計要件：外部/アーキ設計で定義）。

#### 重要度判定ルール v1（MVP）
- HIGH（今すぐ対応）
  - クラッシュ/起動不能を示す語が含まれる
  - 課金/購入/サブスクの不具合を示す語が含まれる
- MID（次の改善候補）
  - UI不満、機能要望、使いづらい等
- LOW（無視してよい可能性が高い）
  - 罵倒のみ・内容が極端に短い・再現性が低そうなノイズ

※語彙や判定の具体は外部設計書で「辞書」として管理する。

---

### 6.5 Today（Top3提示）
**FR-TODAY-001（Must）**  
Today画面に「今日対応すべきレビューTop3」を表示する。

**FR-TODAY-002（Must）**  
Top3の選定ロジック：  
1) HIGHを優先  
2) 同重要度なら新しいものを優先  
3) それでも足りない場合はMIDから補完  
（LOWはTop3に原則入れない）

**FR-TODAY-003（Must）**  
Top3各項目に以下を表示する：
- rating（★）
- 重要度（HIGH/MID/LOW）
- 理由タグ
- レビュー本文（先頭N文字のプレビュー）
- 投稿日時（相対でも可、詳細で絶対日時）

---

### 6.6 レビュー詳細
**FR-DETAIL-001（Must）**  
レビュー詳細画面で本文全体、重要度、理由、日時を表示する。

**FR-DETAIL-002（Should）**  
「Play Consoleで開く」リンクを提供する（返信はMVP外）。

---

### 6.7 通知
**FR-NOTIF-001（Must）**  
毎日1回（固定時刻：例 9:00）、重要レビューがある場合のみ通知する。

**FR-NOTIF-002（Must）**  
通知内容は短く、重要度と概要が分かる文字列にする（トークンや機微情報を含めない）。

通知例：
- 「今日の重要レビュー：3件（クラッシュ/課金）」  
- 「重要レビューあり：起動不能・課金反映なし など」

**FR-NOTIF-003（Should）**  
通知をタップするとToday画面に遷移する。

**FR-NOTIF-004（Could / 将来）**
通知時刻をユーザーが設定できる。

**FR-NOTIF-005（Must）**
Android 13+ で通知権限（POST_NOTIFICATIONS）が未許可、またはOS設定で通知が無効な場合、
アプリは通知を表示しない。バックグラウンド同期（Worker）は例外なく完走し、失敗扱いにしない。

---

### 6.8 ログ・クラッシュ収集
**FR-OBS-001（Must）**  
クラッシュ・致命的例外を収集できる（Crashlytics等）。

**FR-OBS-002（Should）**  
同期エラー（401/403/タイムアウト等）をイベントとして記録できる（個人情報を含めない）。

---

## 7. 非機能要件（NFR：Non-Functional Requirements）
### 7.1 品質・性能
**NFR-PERF-001（Must）**  
Today画面は1秒以内に表示（キャッシュ表示で可）。  
ネットワーク同期はバックグラウンドで行い、UIが固まらないこと。

**NFR-PERF-002（Should）**  
初回同期以外は差分取得を推奨（実装はチケット#2以降）。

### 7.2 セキュリティ
**NFR-SEC-001（Must）**  
アクセストークン等の機微情報をログ出力しない。

**NFR-SEC-002（Must）**  
トークンは端末内に安全に保存する。  
MVP段階はDataStoreでもよいが、β公開前に暗号化（Jetpack Security等）を検討する。

### 7.3 プライバシー・データ保持
**NFR-PRIV-001（Must）**  
レビュー本文は端末内キャッシュとして扱い、保持期間（例：30日）を明示する。  
保持期間を超えたデータは削除する。

**NFR-PRIV-002（Must）**  
レビュー本文・トークン等を外部サーバへ送信しない（MVP）。

### 7.4 可用性・耐障害
**NFR-REL-001（Must）**  
ネットワーク不安定、トークン期限切れでもアプリが落ちない。

**NFR-REL-002（Must）**  
401/403/ネットワークエラー時、ユーザーが次に何をすべきか分かるメッセージを表示する。

### 7.5 運用性
**NFR-OPS-001（Should）**  
内部テスト（Internal testing）で配布できる状態を早期に作る。  
クラッシュ回収の仕組みを先に整える。

---

## 8. エラー/例外要件（ユーザーに見せるべき挙動）
### 8.1 401 Unauthorized
- 状況：トークン期限切れ/無効
- 挙動：
  - 自動更新を試す（可能なら）
  - 失敗したら「再ログインしてください」ボタンを表示

### 8.2 403 Forbidden
- 状況：Play Console権限不足、対象packageNameにアクセス不可
- 挙動：
  - 「このGoogleアカウントに対象アプリの権限がありません」等を表示
  - 対処：Play Console権限確認/別アカウントでログイン/別packageName入力

### 8.3 ネットワーク不通
- 挙動：
  - キャッシュがあればキャッシュを表示
  - 「更新できませんでした（通信）」を表示
  - 再試行ボタン

---

## 9. リリース要件（MVPの出荷判定）
### 9.1 Internal testing 出荷条件（最小）
- 起動・画面遷移が可能
- Google連携が成功または失敗理由を表示できる
- API疎通で 200/401/403 を判別し、ユーザーに表示できる
- クラッシュ収集が動作

### 9.2 Closed testing 出荷条件（MVP）
- レビュー取得・保存が動作
- 重要度判定が付与される
- TodayでTop3が表示される
- 通知が条件通りに動作
- 主要なエラー（401/403/通信）がUIで案内される

---

## 10. 受け入れテスト（AT：Acceptance Test）例
新人でも確認できる「手順→期待結果」形式。

### AT-001 サインイン
- 手順：SignInでGoogle連携を行う
- 期待：Connected/Setupへ進む。失敗時は理由が表示される。

### AT-002 packageName設定
- 手順：packageNameを入力し保存
- 期待：保存成功。403の場合は権限不足の案内が出る。

### AT-003 レビュー同期
- 手順：手動更新を押す
- 期待：同期が走り、最終同期時刻が更新される。失敗時は原因が表示される。

### AT-004 Today Top3
- 手順：Todayを開く
- 期待：Top3が表示される（優先順位ルールに従う）。

### AT-005 通知

**ケースA：Android 13+ / 通知 未許可**
- 手順：通知権限を未許可にした状態で、重要レビューあり状態の通知タイミングを迎える（またはデバッグで擬似発火）
- 期待：アプリが落ちない。通知は出なくてOK。

**ケースB：Android 13+ / 通知 許可**
- 手順：通知権限を許可した状態で同条件
- 期待：通知が来る。タップでTodayへ遷移する。

**ケースC：OS設定で通知OFF（端末側でアプリ通知を無効化）**
- 手順：端末の設定でアプリ通知をOFFにした状態で同条件
- 期待：アプリが落ちない。通知は出なくてOK。

> **テスト既知事項（Android 13+）**
> 通知許可を一度拒否すると、再度「通知を許可する」を押してもOSがダイアログを再表示しない場合がある。
> その場合は「通知設定を開く」からOS設定で手動で許可する。
> 初回の未許可状態に戻すにはアンインストール→再インストールが必要。

---

## 11. 将来拡張（参考：要件の外）
- 複数アプリ監視
- 週次レポートの自動生成
- AI分類（精度向上、言語対応強化）
- 返信補助（テンプレ/AI）
- “急増検知”など異常検知

---

## 12. 次の文書（外部設計書）への引き継ぎ項目
- 画面遷移図（SignIn → Setup → Today → Detail → Settings）
- API I/F（どのエンドポイントを叩くか、レスポンスから何を保存するか）
- DB（Room）スキーマ案
- 重要度判定ルール辞書（キーワードリスト）
- 通知スケジュールの実装方式（WorkManagerなど）