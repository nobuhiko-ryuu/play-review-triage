# Androidアプリ開発ルール（工程・品質・運用）

目的：手戻りを減らし、品質を安定させ、AI（Codex等）にも誤解なく作業委任できる状態を作る。

---

## 0. 基本原則
- MVP優先：スコープを増やす前に「やらないこと」を確定する
- 小さく作って早く統合：PRは小さく、毎日統合
- 仕様の正は「受け入れ条件」：文章ではなくYes/No判定できる形で固定する
- テストは並走：後回しにしない
- 観測できない改善は改善ではない：必要な計測/監視を最初から入れる

---

## 1. 進め方（Dual-track）
### 1.1 Discovery（作るべきものの確定）
- 成果物：PRD（短くて良い）/ ユーザーストーリー / 受け入れ条件 / 画面ラフ / 非機能 / 計測
- 完了条件：`docs/DEFINITION_OF_READY_DONE.md` の DoR を満たすこと

### 1.2 Delivery（実装と品質担保）
- 成果物：動く機能 + テスト + CIグリーン + PRテンプレのチェック完了
- 完了条件：`docs/DEFINITION_OF_READY_DONE.md` の DoD を満たすこと

---

## 2. 仕様ルール（必須）
- すべての機能は「ユーザーストーリー + 受け入れ条件（Given/When/Then）」で表す
- 画面がある場合、状態（Normal/Loading/Empty/Error/Permission）を必ず定義する
- 重要な決定（揉めそうなもの）はADRで残す：`docs/adr/`

---

## 3. 実装ルール（Kotlin + Compose）
- レイヤ分離：UI / Data /（必要なら）Domain
- UIは単一のUI Stateで描画し、イベントはIntent/EventとしてViewModelへ集約する
- 例外は握りつぶさない：ユーザー表示/再試行/ログを分離して設計する
- シークレットはリポジトリにコミットしない

---

## 4. Git / PR運用（必須）
### 4.1 ブランチ
- 短命ブランチ + PR（Trunk-based寄り）
- 命名例：`feat/xxx` `fix/xxx` `chore/xxx` `docs/xxx`

### 4.2 PRテンプレ運用（必須）
- PR作成時は `.github/PULL_REQUEST_TEMPLATE.md` を必ず埋める
- チェックリスト（DoD）が満たせない場合、理由を明記するかPRを分割する

### 4.3 PRサイズ
- 目安：レビュー30分以内
- 超える場合：分割するか、分割できない理由とレビュー観点をPR本文に明記

---

## 5. テスト戦略
- 速いテスト（Unit）を厚く、遅いテスト（Instrumented/UI）を薄く
- “壊れたら痛いところ”から守る（網羅より優先）
- Flakyテストは放置しない：隔離/修正/削除を即判断

---

## 6. CI（品質ゲート）
- 最低限：Lint/静的解析、Unit Test、assemble
- CIが赤い状態は最優先で復旧する（仕様より優先）

---

## 7. リリース運用
- Internal → Closed → Production の順で出す
- 可能なら段階的ロールアウト
- リリース前チェック：クラッシュ傾向 / 主要導線 / バージョン情報

---

## 8. AI（Codex等）依頼テンプレ
依頼文に必ず含める：
- 目的 / 背景
- 受け入れ条件（Given/When/Then）
- 変更範囲（ファイル/モジュール目安）
- 動作確認手順
- 制約（例：commit/push手順は不要 等）

AIの回答に必ず含めさせる：
- 修正方針（理由）
- 変更点一覧（ファイル単位）
- 確認手順（Gradleタスク含む）
- 追加/更新したテストの説明